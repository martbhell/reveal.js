<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Object Storage + ExaBGP: Customer Invisible Maintenance</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<section>
						This slideset is made using <a href="https://github.com/hakimel/reveal.js/" target="_blank">reveal.js</a>.
<br />

You can change slides with the *arrow keys*.
<br />

You can get an overview of all the slides by pressing *esc*.
<br />

Press **↓** to see an index of topics.
<br />
Press **→** one or more times to select topic.

					</section>
					<section data-background="topic_background.png" data-background-size="contain">
						Invisible Maintenance<br />with ExaBGP<br /> <font size="+2">FUNET Technical Days 2018 <br /> Johan Guldmyr & CSC Pouta Cloud Team</font>
					</section>
					<section>
						Credits to FUNET, CSC Cloud and Network Team

					</section>
					
				</section>
				<section>
					<section>
						<h1>What is Pouta?</a>

						Infrastructure as a Service <br />

						<a href="https://research.csc.fi/cloud-computing" target="_blank">https://research.csc.fi/cloud-computing</a> <br />
					</section>

					<section>
						<h1>What is Object Storage?</a>
					</section>
					<section>

<pre>
curl -qs https://exabgp.object.pouta.csc.fi/index.html|head
</pre>						

You get some HTML back. 

<pre>
curl https://cats.object.pouta.csc.fi/cat.jpg
</pre>

If it's a picture you get the picture.
					</section>
					<section>
						<a href="https://research.csc.fi/pouta-object-storage" target="_blank">https://research.csc.fi/pouta-object-storage</a> <br />:
						"Object storage is a cloud storage service, where you can store and retrieve data over HTTPS. This is not tied to any individual virtual machines. The data can be made accessible from anywhere, inside and outside cPouta. For those familiar with commercial cloud services, the Amazon S3 is an example of an object storage service."
					</section>
				</section>
				<section>
					<section>
						<h1> traffic flow </h1>
					</section>
					<section>
						curl https://exabgp.object.pouta.csc.fi/index.html > <br />
						DNS Round Robin > <br />
						IP A, B or ? > <br />
						HAProxy TLS Proxy > <br />
						Ceph RadosGW TCP localhost 7480
					</section>
					<section>
						After this point the Ceph RadosGW acts as a CEPH client and fetches objects from the CEPH cluster.

						This example was a read of a public object. <br /> 
						A few more connections to authentication service are involved with a private object.
					</section>
					<section>

						There are <a href="https://research.csc.fi/pouta-using-object-storage" target="_blank" ="link to our documentation for usage of some clients">many clients</a> one can use with S3. awscli comes with an S3 client inside, openstack CLI has a swift client built-in.

					</section>
				</section>
				<section>

					<section>
						<h1> Before </h1>

					</section>
					<section>
						<img src="exabgp_traffic_diagram.png">
					</section>
					<section>
						Client resolves the DNS into an IP. <br />
						The IP is bound to a normal Ethernet interface in a Linux Virtual Machine.
					</section>


				</section>
				<section>
					<section>
	
					<h1> Why change?</h1>
					</section>
					<section>

						DNS round robin decent for load balancing <br />
						But for failover & High Availability this was found lacking.

					</section>
				</section>
				<section>

					<section>
						<h1> Changes </h1>

					</section>
					<section>

<pre>
Discuss with local network team (need a BGP router pair to peer with)
Exabgp configs
Healthcheck configs 
No changes to haproxy / radosgw at all? 
</pre>
					</section>

					<section>
						<img src="exabgp_traffic_diagram_after.png">
					</section>

					<section>
						Instead of one IP bound to an interface on one server we now: <br />
						Bind multiple IP addresses to dummy/loopback interfaces on multiple servers. <br />
						Then we announce all IP addresses from all servers.
					</section>

					<section>
						<a href="https://github.com/Exa-Networks/exabgp">https://github.com/Exa-Networks/exabgp</a>
						<p align="left">
						<br /> - Recommended by CSC network team & FUNET
						<br /> - low resource footprint and small number of software dependencies
						<br /> - it is not a full routing suite
						<br /> - Python - which we as Openstack operators are familiar with
						<br /> - does not bind a listening socket
						</p>
					</section>

				</section>

				<section>
					<section>

					<h1> More details! </h1>

					The info from the healthcheck during normal operation on node1 looks like:

<pre>
announce route 86.50.254.0/32 next-hop 193.x.y.z med 120
announce route 86.50.254.1/32 next-hop 193.x.y.z med 130
</pre>
					</section>
					<section>

					On node2 it’s almost the same except that the MED values (cost for the route, lower is more preferred) are reversed:

<pre>
announce route 86.50.254.0/32 next-hop 193.x.y.a med 130
announce route 86.50.254.1/32 next-hop 193.x.y.a med 120
</pre>
					</section>
					<section>

					If the health check fails then the MED is increased to 1100 and 1110.


					When we have disabled the node (this is in ExaBGP’s built-in healthcheck.py done by touching a file):
<pre>
announce route 86.50.254.0/32 next-hop 193.x.y.a med 2200 community [ 65535:0 ]
announce route 86.50.254.1/32 next-hop 193.x.y.a med 2210 community [ 65535:0 ]
</pre>
					</section>

					<section>
						<h1> Health Check details </h1>
					</section>

					<section>
						ExaBGP 3.4 is the current recommended version. 

						We use the built-in healthcheck.py of ExaBGP. This is a python script which checks if the CEPH http daemon (civetweb) responds to a curl GET request and depending on a good or bad result writes different announce lines to stdout.
					</section>
					<section>

						It’s possible to easily disable a node in ExaBGP by touching a file. Because we wanted to send a community ( we use the well-known “BGP Graceful Shutdown” community 65535:0 ) with the announcement when we disable a node we made some changes to the healthcheck.py script with pull requests to ExaBGP

					</section>

				</section>
				<section>
				<h1> Maintenance Procedure</h1>

				<br /> - Remove the IP from the DNS entry of object.pouta.csc.fi
				<br /> - Wait until there are no transfers anymore to this IP.
				<br /> - Do the maintenance
				<br /> - Add the IP back to DNS

				</section>
				
				<section>
				<h1> Graph during maintenance </h1>
				Graphs / Process
				</section>

				<section>
					<section>
					<h1> end scene</h1>
					</section>
					<section>
						No changes or restart of the service were needed.
					</section>
					<section>
					
					We use puppet to configure our object servers. This code is unfortunately not (yet) public. If anybody wants more details about how it is done with puppet please get in touch. In summary we:
					</section>
					<section>

	Add a dummy interface with the service IPs. <br />
	Use modprobe config to load the dummy kernel module AND runs "/sbin/ip link add fake0 type dummy" on boot <br />
	A network-scripts/ifcfg-fake0 (we run CentOS7) with several IP addresses and /32 netmasks <br />
	We used fake0 instead of dummy0 because of puppet facts ordering issues <br />
	Setup a python virtualenv where we install exabgp <br />
	Add a systemd that runs exabgp from within this virtualenv <br />
					</section>

					<section>

					We add the IP on the dummy interface because that is networking best practice :)
					
					The IP addresses are not used in the machine’s local routing table. So “ip route” does not have them and on CentOS 7 if you run tcpdump you need to use it on the normal interface, like "$ tcpdump -i eth0 ‘host 86.50.254.0’"
					</section>
					<section>

					 * magic invisibility maintenance caveat: Some clients don’t like when a connection suddenly changes from talking with one server to another. We have done a bit of testing and have seen that python-swiftclient (v3.5.0) reads get an ECONNRESET error. Uploads or writes however retry and works . The aws-cli works fine for both writes and reads.
					 </section>
				</section>
				
				<section>
				<h1> Links and blogs </h1>

				<a href="https://pouta.blog.csc.fi/2018/03/customer-invisible-maintenance-of-csc.html" target="_blank">https://pouta.blog.csc.fi/</a> <br />
				<a href="https://research.csc.fi/pouta-object-storage" target="_blank">https://research.csc.fi/pouta-object-storage</a>
				</section>
				
				<section>
				<h1> Questions? </h1>
				</section>
				

			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
